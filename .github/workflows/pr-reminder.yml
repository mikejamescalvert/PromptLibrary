name: PR Review Reminder

on:
  schedule:
    - cron: '0 14 * * 1-5'  # Weekdays at 2:00 PM UTC
  workflow_dispatch:          # Manual trigger

jobs:
  check-open-prs:
    name: Check Open PRs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for open PRs and create reminder issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch open PRs as JSON
          PRS=$(gh pr list --state open --json number,title,author,createdAt,url,headRefName --limit 50)
          COUNT=$(echo "$PRS" | jq length)

          if [ "$COUNT" -eq 0 ]; then
            echo "No open PRs found. Skipping."
            exit 0
          fi

          echo "Found $COUNT open PR(s). Creating reminder issue."

          # Build markdown table
          PR_TABLE="| # | Title | Author | Branch | Opened |\n|---|-------|--------|--------|--------|\n"
          while IFS= read -r pr; do
            NUM=$(echo "$pr" | jq -r '.number')
            TITLE=$(echo "$pr" | jq -r '.title')
            AUTHOR=$(echo "$pr" | jq -r '.author.login')
            CREATED=$(echo "$pr" | jq -r '.createdAt' | cut -d'T' -f1)
            URL=$(echo "$pr" | jq -r '.url')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            PR_TABLE="${PR_TABLE}| [#${NUM}](${URL}) | ${TITLE} | @${AUTHOR} | \`${BRANCH}\` | ${CREATED} |\n"
          done < <(echo "$PRS" | jq -c '.[]')

          # Close any previous reminder issues
          gh issue list --label "pr-reminder" --state open --json number --jq '.[].number' | while read -r num; do
            gh issue close "$num" --comment "Superseded by new daily reminder."
          done

          # Create the reminder issue
          BODY=$(printf "## Open Pull Requests\n\nThere are **%s** open PR(s) waiting for review:\n\n%b\n\nPlease review at your earliest convenience.\n\n> Auto-generated by the PR Review Reminder workflow." "$COUNT" "$PR_TABLE")

          gh issue create \
            --title "PR Review Reminder: ${COUNT} open PR(s) â€” $(date -u +%Y-%m-%d)" \
            --body "$BODY" \
            --label "pr-reminder"
