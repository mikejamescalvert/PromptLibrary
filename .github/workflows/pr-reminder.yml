name: PR Review Reminder

on:
  schedule:
    - cron: '0 14 * * 1-5'  # Weekdays at 2:00 PM UTC
  workflow_dispatch:          # Manual trigger

jobs:
  check-open-prs:
    name: Check Open PRs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for open PRs and send reminder
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          # Fetch open PRs as JSON
          PRS=$(gh pr list --state open --json number,title,author,createdAt,url,headRefName --limit 50)
          COUNT=$(echo "$PRS" | jq length)

          if [ "$COUNT" -eq 0 ]; then
            echo "No open PRs found. Skipping notification."
            exit 0
          fi

          echo "Found $COUNT open PR(s). Building email."

          # Build PR table rows
          PR_ROWS=""
          while IFS= read -r pr; do
            NUM=$(echo "$pr" | jq -r '.number')
            TITLE=$(echo "$pr" | jq -r '.title')
            AUTHOR=$(echo "$pr" | jq -r '.author.login')
            CREATED=$(echo "$pr" | jq -r '.createdAt' | cut -d'T' -f1)
            URL=$(echo "$pr" | jq -r '.url')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            PR_ROWS="${PR_ROWS}<tr><td><a href=\"${URL}\">#${NUM}</a></td><td>${TITLE}</td><td>${AUTHOR}</td><td>${BRANCH}</td><td>${CREATED}</td></tr>"
          done < <(echo "$PRS" | jq -c '.[]')

          # Build HTML email body
          BODY="<html><body>
          <h2>Open Pull Requests — ${{ github.repository }}</h2>
          <p>There are <strong>${COUNT}</strong> open PR(s) waiting for review:</p>
          <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse:collapse;\">
          <tr style=\"background:#f0f0f0;\"><th>#</th><th>Title</th><th>Author</th><th>Branch</th><th>Opened</th></tr>
          ${PR_ROWS}
          </table>
          <p>Please review and merge or close these PRs at your earliest convenience.</p>
          <p><a href=\"https://github.com/${{ github.repository }}/pulls\">View all PRs on GitHub</a></p>
          </body></html>"

          echo "$BODY" > email_body.html

      - name: Send email notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "PR Review Reminder: ${{ github.repository }} — Open PRs awaiting review"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}
          html_body: file://email_body.html
          ignore_cert: true
